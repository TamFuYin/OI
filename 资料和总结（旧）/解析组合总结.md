前言：WC 上传说中的 EI 大巨讲了一些多项式魔法，作为一个毕恭毕敬的初三小蒟蒻自然是要做一些笔记的。

~~不过也太多了吧~~

# 多项式科技

加减法，自无需多言。乘法就 NTT（自己学）。

## 微积分

稍微讲一讲。
$$
\frac{\mathrm d}{\mathrm dx}f(x)=\lim_{h\to0}\frac{f(x+h)-f(x)}h
$$
导函数可以看作函数在所有点的斜率组成的函数。
$$
\begin{aligned}
\frac{\mathrm d}{\mathrm dx}x^n&=\lim_{h\to0}\frac{(x+h)^n-(x)^n}h\\
&=\lim_{h\to0}\frac{\sum_{k=0}^n{n\choose k}x^kh^{n-k}-x^n}h\\
&=\lim_{h\to0}\frac{\sum_{k=0}^{n-1}{n\choose k}x^kh^{n-k}}h\\
&=\lim_{h\to0}\sum_{k=0}^{n-1}{n\choose k}x^kh^{n-k-1}\\
&当~h\to 0~时,前~n-1~项都趋近于~0,\\&唯有最后一项因为~n-(n-1)-1=0~而没有~h\\
&={n\choose n-1}x^{n-1}\\
&=nx^{n-1}\\
\end{aligned}
$$
此外容易证明微分是一个线性变换，因此可以容易地计算出多项式的微分。

令 $f(x)=\sum_{n\in\N}f_nx^n$，则 $f'(x)=\sum_{n\in\N}nf_nx^{n-1}=\sum_{n\in\N}(n+1)f_{n+1}x^n$

同样的，对于微分的逆变换——积分，也是容易的。
$$
\int x^n=\frac{x^{n+1}}{n+1}+C
$$
不过多项式中，我们常用 $\int_0^z$ 的定积分，因为
$$
\int_0^z(\sum_{n\ge0}f_nz^n)=(\sum_{n\ge0}\frac{f_{n-1}}{n}z^n)\big|_0^z=\sum_{n\ge0}\frac{f_{n-1}}{n}z^n
$$

## 牛顿迭代法

给定 $g(z)$，求
$$
g(f(z))=0
$$
的解 $f(z)$

对于 $\pmod{z^1}$，直接解方程。

假设已求出 $\pmod{z^{n/2}}$ 的解 $\hat f(z)$，

那么在 $\hat f(z)$ 处对 $g(f(z))$ 泰勒展开，得到
$$
g(f(z))=\sum_{m\ge0}g^{(m)}(\hat f(z))\frac{(f(z)-\hat f(z))^m}{m!}\equiv 0\pmod{z^n}
$$
由于 $f(z)$ 和 $\hat f(z)$ 的前 $n/2$ 项（包括 $0$ 次项）一模一样，所以 $\forall m\ge 2$，$(f(z)-\hat f(z))^m\equiv 0\pmod {z^n}$

因此 $g(\hat f(z))+g'(\hat f(z))(f(z)-\hat f(z))\equiv0$，即 $f(z)=\hat f(z)-\frac{g(\hat f(z))}{g'(\hat f(z))}$

应用牛顿迭代法时，需要对其进行转化，选择易于处理的 $g$。

## 乘法逆

直接牛迭。
$$
求~g=1/f\\
即~1/f-g=0\\
令~h(f)=1/f-g，则方程转化为~h(f)=0\\
h'(f)=-1/f^2\\
f\equiv\hat f-h(\hat f)/h'(\hat f)=\hat f-(1/\hat f-g)/(-1/\hat f^2)=\hat f+(\hat f-g\hat f^2)=2\hat f-g\hat f^2\pmod{z^n}
$$
注意，这里请把 $g$ 看作一个与 $f$ 无关的**常数**！

这里的 $g$ 是 $\bmod{z^n}$ 的，$2\hat f-g\hat f^2$ 的次数是 $\Theta(2n)$ 的，所以你要在 `NTT` 时多插一些，然后截断它。

## 对数

$$
f(z)=\ln g(z)\\
e^{f(z)}=g(z)\\
f(z)e^{f(z)}=g'(z)\\
f(z)g(z)=g'(z)\\
f(z)=\int_0^z\frac{g'(z)}{g(z)}
$$

$\Theta(n\log n)$

## 指数

给定 $g(z)$ 求 $f(z)=e^{g(z)}$。直接牛迭。
$$
f=\exp g\\
\ln f=g\\
h(f)=\ln f-g=0\\
h'(f)=1/f\\
f=\hat f-(h(\hat f))/(h'(\hat f))=\hat f-(\ln \hat f-g)\hat f=\hat f(1-\ln \hat f+g)
$$

# 解析组合

## 无标号计数

#### 组合类

组合类是一个集合 $\mathscr A$ 以及附带的大小函数 $|\cdot|_{\mathscr A}:\mathscr A\to\N$。

定义 $\mathscr A$ 的计数序列为 $a_n=\sum_{\alpha\in \mathscr A}[|\alpha|=n]$。

#### OGF

定义 $a$ 的 OGF 为形式幂级数 $A(z)=\sum_{n\in\N}a_nz^n=\sum_{\alpha\in \mathscr A}z^{|\alpha|}$

中性类 $\mathscr E$ 有 $E(z)=1$，原子类 $\mathscr Z$ 有 $Z(z)=z$。

#### 笛卡尔积

对于两个组合类 $\mathscr A,\mathscr B$，它们的笛卡尔积 $\mathscr C=\mathscr A\times\mathscr B$ 的大小函数为 $|(\alpha,\beta)|_\mathscr C=|\alpha|_\mathscr A+|\beta|_\mathscr B$

容易证明 $C(z)=A(z)\times B(z)$

笛卡尔积可以理解为把两个组合类的组合对象有序地拼在一起（有序数对嘛），例如串的拼接。

#### 无交并

显然 $\mathscr A\cap\mathscr B=\varnothing\land\mathscr A\cup\mathscr B=\mathscr C\implies A(z)+B(z)=C(z)$

#### 加法

其实就是真·不交并 $\mathscr A+\mathscr B=\mathscr A\times\mathscr E_1\cup\mathscr B\times\mathscr E_2=\mathscr C\implies C(z)=A(z)\times1+B(z)\times1=A(z)+B(z)$

#### Sequence（序列） 构造

$\mathscr A$ 的 Sequence 构造意味着满足以下条件的任意长度的（有序的）数列的集合：数列的每一个元素都是 $\mathscr A$ 中的一个元素，且数列的「大小」为各元素大小之和。

即 $\mathrm{SEQ}(\mathscr A)=\{(\alpha_1,\dots,\alpha_l)|l\ge0,\alpha\in\mathscr A\}$。

因此 $\mathrm{SEQ}(\mathscr A)=\sum_{n\in\N}\mathscr A^n$，特别地，$\mathscr A^0=\mathscr E$。

令 $\mathscr B=\mathrm{SEQ}(\mathscr A)$，则 $B(z)=\sum_{n\in\N}A^n(z)=\frac1{1-A(z)}$

#### Multiset（多重集）构造

$\mathscr A$ 的 Multiset 构造意味着满足以下条件的任意长度的（无序的）多重集合的集合：多重集合的每一个元素都是 $\mathscr A$ 中的一个元素，且多重集合的「大小」为各元素大小之和。

即 $\mathrm{MSET}(\mathscr A)=\{\{\alpha_1,\dots,\alpha_l\}|l\ge0,\alpha\in\mathscr A\}$。

由于不区分元素排列顺序，依次考虑每个元素出现多少次，即 $\mathrm{MSET}(\mathscr A)=\prod_{\alpha\in\mathscr A}\mathrm{SEQ(\alpha)}$

令 $\mathscr B=\mathrm{MSET}(\mathscr A)$，则
$$
\begin{aligned}
B(z)&=\prod_{\alpha\in\mathscr A}\frac1{1-z^{|\alpha|}}\\
&=\prod_{n\in\N}(\frac1{1-z^n})^{a_n}\\
&=\exp\ln\prod_{n\in\N}(1-z^n)^{-a_n}\\
&=\exp\sum_{n\in\N}-a_n\ln(1-z^n)\\
&=\exp\sum_{n\in\N}-a_n\sum_{m\ge1}\frac{(-1)^{m-1}}m(-z^n)^m\\
&=\exp\sum_{n\in\N}a_n\sum_{m\ge1}\frac{z^{nm}}m\\
&=\exp\sum_{m\ge1}\frac1m\sum_{n\in\N}a_nz^{nm}\\
&=\exp\sum_{n\ge1}\frac{A(z^n)}n\\
\end{aligned}
$$

容易看出来如果 $a_0\ne 0$，则 $b_0$ 不收敛。

> 贴上公式
> $$
> \ln(1+z)=\sum_{n\ge 1}\frac{(-1)^{n-1}}nz^n
> $$

貌似叫做又叫做欧拉变换（？）

如果我们要求出答案 $\bmod z^m$ 的结果，那么对于每个 $n$，只需要计算 $\Theta(m/n)$ 的有用的项，时间复杂度 $\Theta(\sum_{n=1}^{m-1}\frac m n)+\Theta(m\log m)=\Theta(m\log n+m\log m)$

例：付公主的背包 $\mathrm{MSET}(由大小为\{v_1,v_2,\dots,v_n\}的元素组成的组合类)$

#### PowerSet（幂集）构造

显然 $\mathrm{PSET}(\mathscr A)=\prod_{\alpha\in\mathscr A}(\mathscr E+\{\alpha\})$

令 $\mathscr B=\mathrm{PSET}(\mathscr A)$，则
$$
B(z)=\sum_{n\in\N}(1+z^n)^{a_n}
$$

## 有标号计数

可以看作每一个“原子”都有一个标号，即每一个元素都是一个排列。

## EGF

$\hat A(z)=\sum_{\alpha\in\mathscr A}\frac{z^{|\alpha|}}{|\alpha|!}$

## 标号积

对于两个有标号组合对象 $\alpha,\beta$，定义标号积 $\alpha*\beta=\{\gamma:\gamma=(\alpha,\beta)$且可以任意分配标号，但是 $\alpha$ 中的原子仍然保持在 $\alpha$ 中的相对顺序 $,\beta$ 亦然 $\}$

对于两个有标号组合类 $\mathscr A,\mathscr B$ ，标号积定义为 $\mathscr A*\mathscr B=\bigcup_{\alpha\in\mathscr A,\beta\in\mathscr B}\alpha*\beta$

于是令 $\mathscr C=\mathscr A*\mathscr B$ 即有 $\hat C(z)=\hat A(z)\times\hat B(z)$

如果说笛卡尔积是序列的拼接，那么标号积就是序列的“混合”，即允许序列的插空。

## Laplace 变换

有时候我们需要把 EGF 转化为 OGF，或者反过来。

当然，这在实现上是非常简单的，但是我们想深入研究它的性质。

定义 $\hat A(z)=\sum_{n\in\N}a_nz^n/n!$ 的 *Laplace 变换* 为
$$
A(z)=\mathcal L\hat A(z)=\sum_{n\in\N}a_nz^n
$$
事实上，$\cal L$ 是线性算子，且 $\mathcal L z^a\mathrm e^{bz}=a!z^a/(1-bz)^{a+1}$（大概可以带进去验算？

## Sequence（序列）构造

$A^k(z)$ 可以看作 $k$ 个 $\mathscr A$ 中的元素标号乘，得到的结果记作 $\mathrm{SEQ}_k(\mathscr A)$。

$\mathrm{SEQ}(\mathscr A)={\huge\cup}_{k\ge0}\mathrm{SEQ}_k(\mathscr A)$

$B(z)=\frac1{1-A(z)}$

## Set（集合）构造

上面的 Sequence 构造事实上区分了乘的顺序，除以一个阶乘就能得到 Set 构造，即
$$
B(z)=\sum_{n\ge0}\frac{A^n(z)}{n!}=\exp A(z)
$$

# 有限制的构造

例题：[烷基计数](https://loj.ac/p/6538)

令 $\mathscr A$ 表示要求的（无标号）组合类，那么显然
$$
\mathscr A=\mathscr Z\times\mathrm{MSET}_{\le3}\mathscr A
$$
事实上可以这样
$$
\mathscr A=\mathscr Z\times\mathrm{MSET}_3(\mathscr A+\mathscr E)
$$
组合解释的话，就是允许在三棵子树里面有几个空的，结果就得到允许零到三棵子树了。

使用这样的方法，我们可以把所有的 $\le$ 换成 $=$，至于 $\ge$，我们可以用总数减去 $<$ 来计算。

求 $\mathrm{MSET}_3$ 可以用 Burnside 定理。

显然，$\mathrm{MSET_k}=\mathrm{SEQ}_k/\mathrm R$

问题是 $\mathrm{MSET}$ 的限制计数不如 $\mathrm{SEQ}$ 显然。

不妨增设一元，以求 $\mathrm{MSET}_k$。