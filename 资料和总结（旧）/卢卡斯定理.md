# 卢卡斯定理

一般用于求解大组合数取模的问题

## Lucas定理

Lucas定理描述如下：对于质数p，有

$$
\binom{n}{m}\equiv\binom{\lfloor n/p\rfloor}{\lfloor m/p\rfloor}\cdot\binom{n\mod p}{m\mod p}\mod p
$$

其中的$\binom{\lfloor n/p\rfloor}{\lfloor m/p\rfloor}$也可以继续用Lucas继续递归求解

证明：
$$
\binom{n}{m}=\frac{(n-m+1)(n-m+2)\cdots n}{1\cdot2\cdot\cdots m}=
$$

## ExLucas定理

对于p不是质数的情况下，仍有ExLucas定理

为了求解$\binom{n}{m}\mod M$，我们考虑使用中国剩余定理

先把M质因数分解：（其中p为素数，k为正整数）
$$
M=p_1^{k_1}\cdot p_2^{k_2}\cdots p_r^{k_r}=\prod_{i=1}^r p_i^{k_i}
$$
因为是质因数分解，所以我们有$\forall i,\forall j,且i\ne j,有p_i^{k_i}与p_j^{k_j}互质$

然后我们构造r个同余方程组
$$
\left
\{\begin{aligned}
\binom{n}{m}\equiv a_1\mod p_1^{k_1}
\\ \binom{n}{m}\equiv a_2\mod p_2^{k_2}
\\ \vdots
\\ \binom{n}{m}\equiv a_r\mod p_r^{k_r}
\end{aligned}
\right.
$$
然后我们发现只要求出a，就能用中国剩余定理求出$\binom{n}{m}$了

问题转化为求$\binom{n}{m}\mod p^k$

因为$\binom{n}{m}=\frac{n!}{m!(n-m)!}$

所以又转化为$\frac{n!}{m!(n-m)!}\mod p^k$

我们想要求m!和(n-m)!的逆元，但是同余方程ax ≡ 1(mod p)有解的条件为gcd(a,p) = 1

然而我们没有这个条件

没有条件就要创造条件

我们从n!中拿走x个p，从m!中拿走y个p，从(n-m)!中拿走z个p。使其互质（换句话说就是拿走所有的p因子）

于是有
$$
\dfrac{\dfrac{n!}{p^x}}{\dfrac{m!}{p^y}\dfrac{(n-m)!}{p^z}}\cdot p^{x-y-z}\mod p^k
$$
于是问题转化为求形如$\large \frac{n!}{p^x}\mod p^k$的问题

逆元直接拓欧

我们把n!展开，得到1 × 2 × ... ×n mod $p^k$，我们把这堆数分成两拨，一拨是含有p这个因子的，另一拨就是与p互质的。

于是得到p × (2 × p) × ... × ( p × $\lfloor \frac{n}{p}\rfloor$ ) × 与p互质的数的乘积,p

前面提个p得到$p^{\lfloor \frac{n}{p}\rfloor}$ × (1 × 2 × ... ×$\lfloor \frac{n}{p}\rfloor$)  × 与p互质的数的乘积

第一项直接扔掉

第二项$\lfloor \frac{n}{p}\rfloor!$可以递归处理，继续拿掉里面的p因子。

对于第三项，根据Wilson定理的某个推论（某人也不会）。

我们把第三段按 $p^k$ 划分，因为 $p^k$ 是 $p$ 的幂，所以每一段中与p互质的数在模意义下是一样的，形式化的说，就是对于任意正整数 $t$，有
$$
\prod_{1\le i \le n,\gcd(i,p)=1}i=\prod_{1\le i\le p^k,\gcd(i,p)=1}\prod_{1\le i+t\cdot p^k\le n}(i+t\cdot p^k)≡\prod_{1\le i\le p^k,\gcd(i,p)=1}i^{\lfloor\frac{n-i}{p^k}\rfloor+1} \mod p^k
$$
然后我们就可以暴力处理一段。

> 根据Wilson 定理:对于任意素数p，存在(p-1)! ≡ -1 (mod p)
> > 证明：对于任意正整数i∈[1,p-1]，他的逆元(mod p意义下)也是一个∈[1,p-1]的正整数。我们于是尝试两两配对，使其乘积（在模意义下）为1，但是有一种情况，即逆元等于它本身，此时无法配对。解同余方程x^2^≡1(mod p)，得两个解x~1~≡1，x~2~≡-1≡p-1。将其配对则x~1~* x~2~ ≡ 1 * (p-1) ≡ p-1 ≡ -1
>
> ~~我也不清楚为什么跟这个有关系~~

$$
1\le i+t\cdot p^k\le n\\
\lceil\frac{1-i}{p^k}\rceil\le t\le\lfloor\frac{n-i}{p^k}\rfloor\\
\lfloor\frac{n-i}{p^k}\rfloor-\lceil\frac{1-i}{p^k}\rceil+1
$$

ax-1=m y

ax+my=1
